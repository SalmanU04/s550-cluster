/*
 * s550_cluster.c
 *
 *  Created on: Jul 1, 2025
 *  Author: salmanumar
 */

#include "s550_cluster.h"
#include "s550_uart.h"
#include <stdbool.h>
#include <stdint.h>
#include "inc/hw_memmap.h"
#include "inc/hw_types.h"
#include "inc/hw_can.h"
#include "inc/hw_ints.h"
#include "driverlib/can.h"
#include "driverlib/interrupt.h"
#include "driverlib/sysctl.h"
#include "driverlib/gpio.h"
#include "driverlib/uart.h"
#include "driverlib/pin_map.h"
#include "utils/uartstdio.h"

tCANMsgObject rxMsg, txMsg;

void sendMsg(uint32_t msgID, uint8_t *msgData){
    // Set txMsg
    txMsg.ui32MsgID = msgID;
    txMsg.ui32MsgIDMask = 0;
    txMsg.ui32Flags = MSG_OBJ_TX_INT_ENABLE;
    txMsg.ui32MsgLen = 8;
    txMsg.pui8MsgData = msgData;

    // Send the message
    CANMessageSet(CAN0_BASE, 2, &txMsg, MSG_OBJ_TYPE_TX);

    UARTprintf("\nSending to ID 0x%X: ", msgID);
    int i;
    for (i = 0; i < 8; i++) {
        UARTprintf("0x%02X ", msgData[i]);
    }
}

/*
   uint8_t testWarning[8] = { 0x1A, 0x58, 0x1A, 0x58, 0x1A, 0x84, 0x1A, 0x74 }; // 0x217
   sendMsg (0x217, testWarning);


   uint8_t fuel[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00 }; // 0x318
   sendMsg (0x318, fuel);              // Does not work

   uint8_t test1[8] = { 0x7C, 0xFF, 0x80, 0x00, 0x7A, 0x40, 0x7C, 0xEA }; // 0x85 -
   sendMsg(0x85, test1);

   uint8_t test2[8] = { 0x7E, 0xE3, 0x7F, 0x39, 0x3D, 0x93, 0xF0, 0x00 }; // 0x91 -
   sendMsg(0x91, test2);

   uint8_t test3[8] = { 0x6F, 0xBA, 0x6F, 0x92, 0x73, 0x62, 0x94, 0x93 };
   sendMsg(0x92, test3);

   uint8_t test4[8] = { 0x00, 0x00, 0x80, 0x47, 0x80, 0x47, 0x00, 0x00 };
   sendMsg(0x200, test4);

   uint8_t test5[8] = { 0x00, 0x00, 0xD0, 0xFA, 0x0F, 0xFE, 0x0F, 0xFE };
   sendMsg(0x415, test5);

   uint8_t test6[8] = { 0x82, 0x00, 0x14, 0x40, 0x7B, 0x00, 0x64, 0xFF };
   sendMsg(0x130, test6);

   uint8_t test7[8] = { 0x00, 0x00, 0x07, 0xFF, 0x7F, 0xF7, 0xE6, 0x02 };
   sendMsg(0x77, test7);

   uint8_t test8[8] = { 0x5C, 0x00, 0x14, 0x98, 0xAF, 0x00, 0x44, 0xFF }; // Steering Mode: Sport
   sendMsg(0x82, test8);

   uint8_t test9[8] = { 0xF0, 0x1C, 0x00, 0x00, 0x4B, 0x00, 0x00, 0x00 };
   sendMsg(0x230, test9);

   uint8_t sendNull[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
   sendMsg (0x81, sendNull);

x4C[8] = { 0x20, 0xAF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00 }; //Airbag and seatbelt
x156[8] = { 0x50, 0x55, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }; //[0] Coolant, AF normal middle 239*F, cold 0x50 = 68*F, Oil Temp [1] 0x55 = LOW, 0xAA = Normal, 0xCC = Warm, 0xDD = High
x171[8] = { 0x14, 0x40, 0x3a, 0x10, 0x00, 0x1a, 0x08, 0x00 }; //Trans [1] , 00 = P, 20 = R, 40 = N, 60 = D, 80 = S
x3C3[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }; //Handbrake
x3B2[8] = { 0x44, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00 }; //Keep alive - Guage cluster specific, door status, hdlight, dimming screen
x416[8] = { 0x5E, 0x00, 0xF0, 0x00, 0x01, 0x00, 0x00, 0x00 }; //Handbrake, ABS [6], AdvanceTrac, Traction Control [5]


*/

void startup(){
    // Initial state of the cluster, should always reset start as this...
    uint8_t sendOn[8] = { 0x40, 0x4A, 0x00, 0x0C, 0x18, 0x00, 0x40, 0x00  }; //0x3B3 - Controls start up
    sendMsg(0x3B3, sendOn);     // Door Ajar does not work
    //TODO: APIM 1,2,3 - 0x44, 0x48, 0x109

}

void warnings(){
    uint8_t warnings[8] = { 0x00, 0x00, 0x00, 0x00, 0x96, 0x00, 0x02, 0xC8 };
    sendMsg (0x179, warnings);

    uint8_t airbagSeatbelt[8] = { 0x10, 0x5F, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00 }; // 0x4C - Controls Airbag and seatbelt indicators
    sendMsg (0x4C, airbagSeatbelt);     //Works for Airbag

    uint8_t absTraction[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }; // 0x416 - Controls ABS, traction control, and brake system warning
    sendMsg (0x416, absTraction);       // Works for ABS and traction

    uint8_t engine[8] = { 0x72, 0x7F, 0x4B, 0x00, 0x00, 0x1A, 0xED, 0x00 }; // 0x167 - Engine state, Engine load, Manifold Abs Pressure
    sendMsg (0x167, engine);

    uint8_t engineTemp[8] = { 0xA6, 0xDA, 0xFF, 0xFF, 0x03, 0xFF, 0xFF, 0xFF }; // 0x156 - Coolant Gauge, Oil Temp Gauge, Overheat Message
    sendMsg (0x156, engineTemp);

    uint8_t TPMSLight[8] =  { 0x40, 0x11, 0x11, 0xFF, 0x25, 0x25, 0x00, 0x00 }; // 0x3B4
    sendMsg (0x3B4, TPMSLight);

    uint8_t misc[8] = { 0x44, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00 }; // 0x3B2 - Gauge Cluster, Door Status, HDlight, Dimming Screen
    sendMsg (0x3B2, misc);

    uint8_t engineLight[8] = { 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00 }; //0x421 - Engine Light byte 0, oil press low/normal bit 2, Oil Press Error
    sendMsg(0x421, engineLight);

    uint8_t battery[8] = { 0x81, 0x00, 0xfc, 0x00, 0x06, 0x60, 0x00, 0x00 }; //0x42C - Battery Error
    sendMsg(0x42C, battery);

}

void launch_controls(){
    uint8_t doorAjar[8] = { 0x4C, 0x48, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00 }; // 0x3C3 - Parking Light, High Beam
    sendMsg (0x3C3, doorAjar);          // Works

    uint8_t tirePressure[8] = { 0x01, 0x1c, 0x01, 0x21, 0x01, 0x1b, 0x01, 0x12 }; // 0x3B5 - Tire Pressue, set to a consistent 30 PSI/ 206 kPA
    sendMsg (0x3B5, tirePressure);      // Works

    uint8_t steeringFault[8] = { 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xFC }; // 0x77 - Steering Fault
    sendMsg (0x77, steeringFault);

    uint8_t drivingState[8] = { 0x14, 0x60, 0x3a, 0x10, 0x00, 0x1a, 0x08, 0x00 }; // 0x171 - Driving State, P,R,N,D,S
    sendMsg (0x171, drivingState);

    uint8_t handbrake[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }; // 0x3C3 - Handbrake
    sendMsg (0x3C3, handbrake);

    uint8_t traction[8] = { 0x5E, 0x00, 0xF0, 0x00, 0x01, 0x00, 0x00, 0x00 }; // 0x416 - Handbrake, ABS, AdvanceTraction, Traction Control
    sendMsg (0x416, traction);



    //TODO: Launch Controls............
}

void navigation(){
    uint8_t sendNull[8] = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };
    sendMsg (0x81, sendNull);
    //TODO: 0x5 series
    uint8_t x5_series1[8] = { 0x81, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    sendMsg (0x581, x5_series1);
    uint8_t x5_series2[8] = { 0x96, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    sendMsg (0x5961, x5_series2);
    uint8_t x5_series3[8] = { 0x9E, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    sendMsg (0x59E, x5_series3);
    uint8_t x5_series4[8] = { 0xB3, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    sendMsg (0x5B3, x5_series4);
    uint8_t x5_series5[8] = { 0xB5, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF };
    sendMsg (0x5B5, x5_series5);
}


void setSpeedRPM(uint16_t speed, uint16_t rpm){
    // b6<<8+b7: Speed, cluster wants multiplied by 100.
    int clusterSpeed = speed * 100;
    uint8_t speedSet[8] = {0x0C, 0x00, 0x00, 0x00, 0x60, 0x00, clusterSpeed>>8, clusterSpeed&0xFF}; // 0x202
    sendMsg(0x202, speedSet);

    // b3<<8+b4: RPM, cluster takes 1/2 of actual RPM
    rpm = rpm/2;
    uint8_t rpmSet[8] = {0x00, 0x00, 0x00, rpm>>8, rpm&0xFF, 0x00, 0x00, 0x00};   // 0x204
    sendMsg(0x204, rpmSet);
}

